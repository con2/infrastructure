- hosts: docker-servers
  gather_facts: yes
  roles:
    - role: base
      tags: [base]
    - role: node-exporter
      tags: [node-exporter]
    - role: docker
      tags: [docker]
    - role: prebackup
      tags: [prebackup]
    - role: nginx
      tags: [nginx]

- hosts: logstash-centrals
  gather_facts: yes
  roles:
    - role: logstash-central
      tags: [logstash-central]
    - role: kibana
      tags: [kibana]

- hosts: legacy-servers
  gather_facts: yes
  roles:
    # - role: rsyslog-to-logstash
    #   tags: [rsyslog-to-logstash]
    - role: node-exporter
      tags: [node-exporter]

- hosts: postgresql-servers
  gather_facts: yes
  roles:
    - role: base
      tags: [base]
    - role: node-exporter
      tags: [node-exporter]
    - role: prebackup
      tags: [prebackup]
    - role: nginx
      tags: [nginx]

    - role: postgresql
      tags: [postgresql]

    - role: letsencrypt
      tags: [letsencrypt]
      letsencrypt_domains:
        # ugly
        - name: siilo.tracon.fi
          subject_alt_name: "DNS:siilo.tracon.fi"

    # default site
    - role: redirect
      tags: [redirect]
      redirect_default: true
      redirect_hostname: "{{ inventory_hostname }}"
      redirect_allowed_hosts: "{{ inventory_hostname }}"
      redirect_target: https://2019.tracon.fi
      redirect_ssl_certificate: /srv/letsencrypt/secrets/siilo.tracon.fi/chained.pem
      redirect_ssl_certificate_key: /srv/letsencrypt/secrets/siilo.tracon.fi/domain.key

- hosts: barman-servers
  gather_facts: yes
  roles:
    - role: base
      tags: [base]
    - role: node-exporter
      tags: [node-exporter]
    - role: postgresql-barman
      tags: [postgresql-barman]

- hosts: tracon-servers
  gather_facts: yes
  roles:
    # default site
    - role: redirect
      tags: [redirect]
      redirect_default: true
      redirect_hostname: "{{ inventory_hostname }}"
      redirect_allowed_hosts: "{{ inventory_hostname }}"
      redirect_target: https://2019.tracon.fi
      redirect_ssl_certificate: /srv/letsencrypt/secrets/tracon.fi/chained.pem
      redirect_ssl_certificate_key: /srv/letsencrypt/secrets/tracon.fi/domain.key

    - role: redirect
      tags: [redirect]
      redirect_hostname: info-tv.tracon.fi
      redirect_allowed_hosts: info-tv.tracon.fi
      redirect_target: https://infotv.tracon.fi
      redirect_ssl_certificate: /srv/letsencrypt/secrets/infotv.tracon.fi/chained.pem
      redirect_ssl_certificate_key: /srv/letsencrypt/secrets/infotv.tracon.fi/domain.key

    - role: redirect
      tags: [redirect]
      redirect_hostname: infoloki.tracon.fi
      redirect_allowed_hosts: infoloki.tracon.fi
      redirect_target: https://infokala.tracon.fi
      redirect_ssl_certificate: /srv/letsencrypt/secrets/infokala.tracon.fi/chained.pem
      redirect_ssl_certificate_key: /srv/letsencrypt/secrets/infokala.tracon.fi/domain.key

    - role: redirect
      tags: [redirect]
      redirect_hostname: hitpoint.tracon.fi
      redirect_allowed_hosts: hitpoint.tracon.fi www.hitpoint.tracon.fi
      redirect_target: https://2019.hitpoint.tracon.fi
      redirect_ssl_certificate: /srv/letsencrypt/secrets/hitpoint.tracon.fi/chained.pem
      redirect_ssl_certificate_key: /srv/letsencrypt/secrets/hitpoint.tracon.fi/domain.key

    - role: redirect
      tags: [redirect]
      redirect_hostname: wiki.hitpoint.tracon.fi
      redirect_allowed_hosts: wiki.hitpoint.tracon.fi
      redirect_target: https://atlasso.tracon.fi/crowd?next=https://confluence.tracon.fi/display/HITPOINT2019
      redirect_ssl_certificate: /srv/letsencrypt/secrets/hitpoint.tracon.fi/chained.pem
      redirect_ssl_certificate_key: /srv/letsencrypt/secrets/hitpoint.tracon.fi/domain.key

    - role: redirect
      tags: [redirect]
      redirect_hostname: wiki.tracon.fi
      redirect_allowed_hosts: wiki.tracon.fi m.wiki.tracon.fi mwiki.tracon.fi
      redirect_target: https://atlasso.tracon.fi/crowd?next=https://confluence.tracon.fi/display/TRACON2019
      redirect_ssl_certificate: /srv/letsencrypt/secrets/tracon.fi/chained.pem
      redirect_ssl_certificate_key: /srv/letsencrypt/secrets/tracon.fi/domain.key

    - role: redirect
      tags: [redirect]
      redirect_hostname: tyovoima.hitpoint.tracon.fi
      redirect_allowed_hosts: tyovoima.hitpoint.tracon.fi
      redirect_target: https://kompassi.eu/events/hitpoint2019/signup
      redirect_ssl_certificate: /srv/letsencrypt/secrets/hitpoint.tracon.fi/chained.pem
      redirect_ssl_certificate_key: /srv/letsencrypt/secrets/hitpoint.tracon.fi/domain.key

    - role: redirect
      tags: [redirect]
      redirect_hostname: tyovoima.tracon.fi
      redirect_allowed_hosts: tyovoima.tracon.fi
      redirect_target: https://kompassi.eu/events/tracon2019/signup
      redirect_ssl_certificate: /srv/letsencrypt/secrets/tracon.fi/chained.pem
      redirect_ssl_certificate_key: /srv/letsencrypt/secrets/tracon.fi/domain.key

    - role: redirect
      tags: [redirect]
      redirect_hostname: ohjelma.tracon.fi
      redirect_allowed_hosts: ohjelma.tracon.fi
      redirect_target: https://kompassi.eu/events/tracon2019/programme
      redirect_ssl_certificate: /srv/letsencrypt/secrets/tracon.fi/chained.pem
      redirect_ssl_certificate_key: /srv/letsencrypt/secrets/tracon.fi/domain.key

    - role: redirect
      tags: [redirect]
      redirect_hostname: animecon.fi
      redirect_allowed_hosts: animecon.fi www.animecon.fi
      redirect_target: https://2016.animecon.fi
      redirect_ssl_certificate: /srv/letsencrypt/secrets/animecon.fi/chained.pem
      redirect_ssl_certificate_key: /srv/letsencrypt/secrets/animecon.fi/domain.key

    - role: redirect
      tags: [redirect]
      redirect_hostname: aicon.fi
      redirect_allowed_hosts: aicon.fi www.aicon.fi m.aicon.fi
      redirect_target: https://2018.aicon.fi
      redirect_ssl_certificate: /srv/letsencrypt/secrets/aicon.fi/chained.pem
      redirect_ssl_certificate_key: /srv/letsencrypt/secrets/aicon.fi/domain.key

    - role: redirect
      tags: [redirect]
      redirect_hostname: kulukorvaus.tracon.fi
      redirect_allowed_hosts: kulukorvaus.tracon.fi
      redirect_target: https://atlasso.tracon.fi/crowd?next=https%3A%2F%2Fjira.tracon.fi%2Fsecure%2FCreateIssue.jspa%3Fpid%3D11100%26issuetype%3D10100
      redirect_ssl_certificate: /srv/letsencrypt/secrets/tracon.fi/chained.pem
      redirect_ssl_certificate_key: /srv/letsencrypt/secrets/tracon.fi/domain.key

    - role: redirect
      tags: [redirect]
      redirect_hostname: tera.tracon.fi
      redirect_allowed_hosts: tera.tracon.fi
      redirect_target: https://confluence.tracon.fi/display/TERA
      redirect_ssl_certificate: /srv/letsencrypt/secrets/tracon.fi/chained.pem
      redirect_ssl_certificate_key: /srv/letsencrypt/secrets/tracon.fi/domain.key

    - role: redirect
      tags: [redirect]
      redirect_hostname: m.tracon.fi
      redirect_allowed_hosts: m.tracon.fi
      redirect_target: https://kompassi.eu/events/tracon2019/programme/mobile
      redirect_ssl_certificate: /srv/letsencrypt/secrets/tracon.fi/chained.pem
      redirect_ssl_certificate_key: /srv/letsencrypt/secrets/tracon.fi/domain.key

    - role: redirect
      tags: [redirect]
      redirect_hostname: kulukorvaus.hitpoint.tracon.fi
      redirect_allowed_hosts: kulukorvaus.hitpoint.tracon.fi
      redirect_target: https://atlasso.tracon.fi/crowd?next=https%3A%2F%2Fjira.tracon.fi%2Fsecure%2FCreateIssue.jspa%3Fpid%3D10800%26issuetype%3D10100
      redirect_ssl_certificate: /srv/letsencrypt/secrets/hitpoint.tracon.fi/chained.pem
      redirect_ssl_certificate_key: /srv/letsencrypt/secrets/hitpoint.tracon.fi/domain.key

    - role: redirect
      tags: [redirect]
      redirect_hostname: kulukorvaus.ry.tracon.fi
      redirect_allowed_hosts: kulukorvaus.ry.tracon.fi
      redirect_target: https://atlasso.tracon.fi/crowd?next=https%3A%2F%2Fjira.tracon.fi%2Fsecure%2FCreateIssue.jspa%3Fpid%3D10302%26issuetype%3D10100
      redirect_ssl_certificate: /srv/letsencrypt/secrets/ry.tracon.fi/chained.pem
      redirect_ssl_certificate_key: /srv/letsencrypt/secrets/ry.tracon.fi/domain.key

    - role: redirect
      tags: [redirect]
      redirect_hostname: beta.conikuvat.fi
      redirect_allowed_hosts: beta.conikuvat.fi conkuvat.fi www.conikuvat.fi www.conkuvat.fi kuvat.aniki.fi uusi.kuvat.aniki.fi
      redirect_target: https://conikuvat.fi
      redirect_ssl_certificate: /srv/letsencrypt/secrets/conikuvat.fi/chained.pem
      redirect_ssl_certificate_key: /srv/letsencrypt/secrets/conikuvat.fi/domain.key

    - role: redirect
      tags: [redirect]
      redirect_hostname: www.con2.fi
      redirect_allowed_hosts: www.con2.fi
      redirect_target: https://con2.fi
      redirect_ssl_certificate: /srv/letsencrypt/secrets/con2.fi/chained.pem
      redirect_ssl_certificate_key: /srv/letsencrypt/secrets/con2.fi/domain.key

    - role: redirect
      tags: [redirect]
      redirect_hostname: wiki.yukicon.fi
      redirect_allowed_hosts: wiki.yukicon.fi
      redirect_target: https://confluence.tracon.fi/display/YUKICON2019
      redirect_ssl: false

    - role: redirect
      tags: [redirect]
      redirect_hostname: www.larppikuvat.fi
      redirect_allowed_hosts: www.larppikuvat.fi larpkuvat.fi www.larpkuvat.fi larp-kuvat.fi www.larp-kuvat.fi
      redirect_target: https://larppikuvat.fi
      redirect_ssl: false

    - role: postgresql-docker
      tags: [postgresql-docker]
      postgresql_hostname: nuoli.tracon.fi
      postgresql_username: infokala
      postgresql_password: "{{ infokala_postgresql_password }}"
      postgresql_database: infokala
      postgresql_ssl_certificate: /srv/letsencrypt/secrets/tracon.fi/chained.pem
      postgresql_ssl_certificate_key: /srv/letsencrypt/secrets/tracon.fi/domain.key

    - role: tracontent
      tags: [tracontent]
      tracontent_setup_site: false
      tracontent_hostname: tracontent.tracon.fi
      tracontent_static_dir: /srv/tracontent.tracon.fi/public_html/static
      tracontent_allowed_host_list:
        - 2016.tracon.fi
        - 2017.tracon.fi
        - 2018.tracon.fi
        - 2019.tracon.fi
        - blog.tracon.fi
        - r.tracon.fi
        - ry.tracon.fi
        - 2015.hitpoint.tracon.fi
        - 2016.hitpoint.tracon.fi
        - 2017.hitpoint.tracon.fi
        - 2019.hitpoint.tracon.fi
      tracontent_editor_group_list:
        - turska-hitpoint2019-labour-conitea
        - turska-tracon2019-labour-conitea
        - traconry-hallitus-nykyinen
      tracontent_blog_comment_moderators: 'Santtu Pajukanta <santtu@pajukanta.fi>, Marjaana Karttunen <maryjane@tracon.fi>, Mitol Meerna <mitol@tracon.fi>, Mari Niemi <lokki@tracon.fi>'

    - role: tracontent
      tags: [tracontent]
      tracontent_setup_instance: false
      tracontent_hostname: tracontent.hitpoint.tracon.fi
      tracontent_allowed_host_list:
        - 2015.hitpoint.tracon.fi
        - 2016.hitpoint.tracon.fi
        - 2017.hitpoint.tracon.fi
        - 2019.hitpoint.tracon.fi
      tracontent_static_dir: /srv/tracontent.tracon.fi/public_html/static
      tracontent_ssl_certificate: /srv/letsencrypt/secrets/hitpoint.tracon.fi/chained.pem
      tracontent_ssl_certificate_key: /srv/letsencrypt/secrets/hitpoint.tracon.fi/domain.key
      tracontent_favicon: null

    - role: tracontent
      tags: [tracontent]
      tracontent_setup_instance: false
      tracontent_hostname: tracontent.ry.tracon.fi
      tracontent_allowed_host_list:
        - ry.tracon.fi
      tracontent_static_dir: /srv/tracontent.tracon.fi/public_html/static
      tracontent_ssl_certificate: /srv/letsencrypt/secrets/ry.tracon.fi/chained.pem
      tracontent_ssl_certificate_key: /srv/letsencrypt/secrets/ry.tracon.fi/domain.key
      tracontent_favicon: null

    - role: tracontent
      tags: [tracontent]
      tracontent_setup_instance: false
      tracontent_hostname: tracontent.tracon.fi
      tracontent_allowed_host_list:
        - 2016.tracon.fi
        - 2017.tracon.fi
        - 2018.tracon.fi
        - 2019.tracon.fi
        - blog.tracon.fi
        - r.tracon.fi
      tracontent_static_dir: /srv/tracontent.tracon.fi/public_html/static
      tracontent_ssl_certificate: /srv/letsencrypt/secrets/tracon.fi/chained.pem
      tracontent_ssl_certificate_key: /srv/letsencrypt/secrets/tracon.fi/domain.key
      tracontent_favicon: null

    - role: tracontent
      tags: [tracontent]
      tracontent_hostname: tracontent.animecon.fi
      tracontent_static_dir: /srv/tracontent.animecon.fi/public_html/static
      tracontent_allowed_host_list:
        - 2016.animecon.fi
      tracontent_ssl_certificate: /srv/letsencrypt/secrets/animecon.fi/chained.pem
      tracontent_ssl_certificate_key: /srv/letsencrypt/secrets/animecon.fi/domain.key
      tracontent_port: 8005
      tracontent_secret_key: "{{ vault_animecon_tracontent_secret_key }}"
      tracontent_postgresql_username: animecon
      tracontent_postgresql_password: "{{ vault_animecon_tracontent_postgresql_password }}"
      tracontent_postgresql_database: animecon
      tracontent_kompassi_oauth2_client_id: "{{ vault_animecon_tracontent_kompassi_oauth2_client_id }}"
      tracontent_kompassi_oauth2_client_secret: "{{ vault_animecon_tracontent_kompassi_oauth2_client_secret }}"
      tracontent_favicon: null
      tracontent_editor_group_list:
        - animecon-staff

    - role: tracontent
      tags: [tracontent]
      tracontent_hostname: tracontent.aicon.fi
      tracontent_static_dir: /srv/tracontent.aicon.fi/public_html/static
      tracontent_allowed_host_list:
        - 2016.aicon.fi
        - 2017.aicon.fi
        - 2018.aicon.fi
      tracontent_ssl_certificate: /srv/letsencrypt/secrets/aicon.fi/chained.pem
      tracontent_ssl_certificate_key: /srv/letsencrypt/secrets/aicon.fi/domain.key
      tracontent_port: 8006
      tracontent_secret_key: "{{ vault_aicon_tracontent_secret_key }}"
      tracontent_postgresql_username: aicon
      tracontent_postgresql_password: "{{ vault_aicon_tracontent_postgresql_password }}"
      tracontent_postgresql_database: aicon
      tracontent_kompassi_oauth2_client_id: "{{ vault_aicon_tracontent_kompassi_oauth2_client_id }}"
      tracontent_kompassi_oauth2_client_secret: "{{ vault_aicon_tracontent_kompassi_oauth2_client_secret }}"
      tracontent_favicon: null
      tracontent_editor_group_list:
        - aicon-staff
        - turska-aicon2018-labour-vastaava

    - role: tracontent-siilo
      tags: [tracontent]
      tracontent_hostname: tracontent.con2.fi
      tracontent_static_dir: /srv/tracontent.con2.fi/public_html/static
      tracontent_allowed_host_list:
        - con2.fi
      tracontent_ssl_certificate: /srv/letsencrypt/secrets/con2.fi/chained.pem
      tracontent_ssl_certificate_key: /srv/letsencrypt/secrets/con2.fi/domain.key
      tracontent_port: 8016
      tracontent_secret_key: "{{ vault_con2_tracontent_secret_key }}"
      tracontent_postgresql_username: con2
      tracontent_postgresql_password: "{{ vault_con2_tracontent_postgresql_password }}"
      tracontent_postgresql_database: con2
      tracontent_kompassi_oauth2_client_id: "{{ vault_con2_tracontent_kompassi_oauth2_client_id }}"
      tracontent_kompassi_oauth2_client_secret: "{{ vault_con2_tracontent_kompassi_oauth2_client_secret }}"
      tracontent_favicon: null
      tracontent_editor_group_list:
        - con2-staff

    - role: kirppu
      tags: [kirppu]

    - role: static
      tags: [static]
      static_hostname: 2005.tracon.fi

    - role: static
      tags: [static]
      static_hostname: 2006.tracon.fi

    - role: static
      tags: [static]
      static_hostname: 2007.tracon.fi

    - role: static
      tags: [static]
      static_hostname: 2008.tracon.fi

    - role: static
      tags: [static]
      static_hostname: 2009.tracon.fi

    - role: static
      tags: [static]
      static_hostname: 2010.tracon.fi

    - role: static
      tags: [static]
      static_hostname: 2011.tracon.fi

    - role: static
      tags: [static]
      static_hostname: 2012.tracon.fi

    - role: static
      tags: [static]
      static_hostname: 2013.tracon.fi

    - role: static
      tags: [static]
      static_hostname: 2014.tracon.fi

    - role: static
      tags: [static]
      static_hostname: 2015.tracon.fi

    - role: static
      tags: [static]
      static_hostname: media.tracon.fi


    - role: infokala
      tags: [infokala]
    - role: infotv
      tags: [infotv]

    - role: edegal
      tags: [edegal, conikuvat]
      edegal_allowed_hosts: conikuvat.fi

    - role: edegal
      tags: [edegal, larppikuvat]
      edegal_image: conikuvat/edegal
      edegal_hostname: larppikuvat.fi
      edegal_port: 8017
      edegal_letsencrypt: true

      edegal_ssl_certificate: /srv/letsencrypt/secrets/larppikuvat.fi/chained.pem
      edegal_ssl_certificate_key: /srv/letsencrypt/secrets/larppikuvat.fi/domain.key

      edegal_allowed_hosts: larppikuvat.fi
      edegal_default_from_email: larppikuvat@con2.fi
      edegal_email_host: sr1.pahaip.fi
      edegal_cache_url: memcache://memcache
      edegal_admins: "Santtu Pajukanta <santtu@pajukanta.fi>"
      edegal_rabbitmq_username: larppikuvat
      edegal_rabbitmq_vhost: larppikuvat
      edegal_postgresql_username: larppikuvat
      edegal_postgresql_database: larppikuvat
      edegal_editor_group: larppikuvat-staff

      edegal_secret_key: "{{ larppikuvat_secret_key }}"
      edegal_postgresql_password: "{{ larppikuvat_postgresql_password }}"
      edegal_rabbitmq_cookie: "{{ larppikuvat_rabbitmq_cookie }}"
      edegal_rabbitmq_password: "{{ larppikuvat_rabbitmq_password }}"
      edegal_kompassi_oauth2_client_id: "{{ larppikuvat_kompassi_oauth2_client_id }}"
      edegal_kompassi_oauth2_client_secret: "{{ larppikuvat_kompassi_oauth2_client_secret }}"

      # no coppermine import :)
      edegal_coppermine_mysql_host: ''
      edegal_coppermine_mysql_username: ''
      edegal_coppermine_mysql_database: ''

      # FIXME ugly. but we'll move to kubernetes anyway soon.
      edegal_volumes:
        - /mnt/coppermine_albums/larppikuvat:/usr/src/app/media

      edegal_media_nginx_fragment: |
          # both conikuvat and larppikuvat use the same static files here!
          location /static/ {
              alias /srv/conikuvat.fi/public_html/static/;
              expires 30m;
          }

          location /media/ {
              alias /mnt/coppermine_albums/larppikuvat/;
              expires 30m;
          }

    - role: redmine
      tags: [redmine]

    - role: oidentd
      tags: [oidentd]
    - role: slackirc
      tags: [slackirc]

    - role: letsencrypt
      tags: [letsencrypt]
      letsencrypt_domains:
        # ugly
        - name: tracon.fi
          subject_alt_name: "DNS:tracon.fi,DNS:www.tracon.fi,DNS:nuoli.tracon.fi,DNS:2016.tracon.fi,DNS:2017.tracon.fi,DNS:2018.tracon.fi,DNS:2019.tracon.fi,DNS:blog.tracon.fi,DNS:r.tracon.fi,DNS:2005.tracon.fi,DNS:2006.tracon.fi,DNS:2007.tracon.fi,DNS:2008.tracon.fi,DNS:2009.tracon.fi,DNS:2010.tracon.fi,DNS:2011.tracon.fi,DNS:2012.tracon.fi,DNS:2013.tracon.fi,DNS:2014.tracon.fi,DNS:2015.tracon.fi,DNS:media.tracon.fi,DNS:kulukorvaus.tracon.fi,DNS:kirppu.tracon.fi,DNS:tera.tracon.fi,DNS:pora.tracon.fi,DNS:pgadmin.nuoli.tracon.fi,DNS:m.tracon.fi,DNS:wiki.tracon.fi,DNS:tyovoima.tracon.fi"
        - name: hitpoint.tracon.fi
          subject_alt_name: "DNS:hitpoint.tracon.fi,DNS:www.hitpoint.tracon.fi,DNS:2015.hitpoint.tracon.fi,DNS:2016.hitpoint.tracon.fi,DNS:2017.hitpoint.tracon.fi,DNS:2019.hitpoint.tracon.fi,DNS:kulukorvaus.hitpoint.tracon.fi"
        - name: ry.tracon.fi
          subject_alt_name: "DNS:ry.tracon.fi,DNS:kulukorvaus.ry.tracon.fi"

        # TODO näillä mitään syytä olla omina varmenteinaan? ehkä siirretään osaks tracon.fi varmennetta
        - name: infotv.tracon.fi
          subject_alt_name: "DNS:infotv.tracon.fi,DNS:info-tv.tracon.fi"
        - name: infokala.tracon.fi
          subject_alt_name: "DNS:infokala.tracon.fi,DNS:infoloki.tracon.fi"

        - name: animecon.fi
          subject_alt_name: "DNS:animecon.fi,DNS:www.animecon.fi,DNS:2016.animecon.fi"
        - name: aicon.fi
          subject_alt_name: "DNS:aicon.fi,DNS:www.aicon.fi,DNS:2016.aicon.fi,DNS:2017.aicon.fi,DNS:2018.aicon.fi,DNS:m.aicon.fi"
        - name: conikuvat.fi
          subject_alt_name: "DNS:conikuvat.fi,DNS:conkuvat.fi,DNS:www.conikuvat.fi,DNS:www.conkuvat.fi"
        - name: larppikuvat.fi
          subject_alt_name: "DNS:larppikuvat.fi,DNS:www.larppikuvat.fi"
        - name: con2.fi
          subject_alt_name: "DNS:con2.fi,DNS:www.con2.fi"

- hosts: kompassi-servers
  gather_facts: yes
  roles:
    # default site
    - role: redirect
      tags: [redirect]
      redirect_hostname: "{{ inventory_hostname }}"
      redirect_allowed_hosts: "{{ inventory_hostname }} www.{{ inventory_hostname }}"
      redirect_target: https://kompassi.eu
      redirect_default: true
      redirect_ssl_certificate: /srv/letsencrypt/secrets/kompassi.eu/chained.pem
      redirect_ssl_certificate_key: /srv/letsencrypt/secrets/kompassi.eu/domain.key

    - role: redirect
      tags: [redirect]
      redirect_hostname: kompassi.tracon.fi
      redirect_allowed_hosts: kompassi.tracon.fi
      redirect_target: https://kompassi.eu
      redirect_ssl_certificate: /srv/letsencrypt/secrets/atlasso.tracon.fi/chained.pem
      redirect_ssl_certificate_key: /srv/letsencrypt/secrets/atlasso.tracon.fi/domain.key

    - role: redirect
      tags: [redirect]
      redirect_hostname: "www.animecon.fi"
      redirect_allowed_hosts: "www.animecon.fi"
      redirect_target: https://animecon.fi
      redirect_ssl_certificate: /srv/letsencrypt/secrets/kompassi.eu/chained.pem
      redirect_ssl_certificate_key: /srv/letsencrypt/secrets/kompassi.eu/domain.key

    - role: redirect
      tags: [redirect]
      redirect_hostname: "www.conit.fi"
      redirect_allowed_hosts: "www.conit.fi"
      redirect_target: https://conit.fi
      redirect_ssl_certificate: /srv/letsencrypt/secrets/kompassi.eu/chained.pem
      redirect_ssl_certificate_key: /srv/letsencrypt/secrets/kompassi.eu/domain.key

    - role: redirect
      tags: [redirect]
      redirect_hostname: "paikkaliput.tracon.fi"
      redirect_allowed_hosts: "paikkaliput.tracon.fi"
      redirect_target: https://kompassi.eu/profile/reservations
      redirect_ssl_certificate: /srv/letsencrypt/secrets/atlasso.tracon.fi/chained.pem
      redirect_ssl_certificate_key: /srv/letsencrypt/secrets/atlasso.tracon.fi/domain.key

    - role: postgresql-docker
      tags: [postgresql-docker]
      postgresql_hostname: kompassi.eu
      postgresql_username: kompassi
      postgresql_password: "{{ kompassi_postgresql_password }}"
      postgresql_database: kompassi
      postgresql_ssl_certificate: /srv/letsencrypt/secrets/kompassi.eu/chained.pem
      postgresql_ssl_certificate_key: /srv/letsencrypt/secrets/kompassi.eu/domain.key

    - role: kompassi
      kompassi_hostname: kompassi.eu
      tags:
        - kompassi
        - kompassi-production

    - role: kompassi2
      tags:
        - kompassi2
        - kompassi2-production

    - role: atlasso
      tags: [atlasso]
    - role: shoottikala
      tags: [shoottikala]

    - role: letsencrypt
      tags: [letsencrypt]
      letsencrypt_domains:
        - name: kompassi.eu
          subject_alt_name: "DNS:kompassi.eu,DNS:www.kompassi.eu,DNS:neula.kompassi.eu,DNS:v2.kompassi.eu,DNS:animecon.fi,DNS:www.animecon.fi,DNS:conit.fi,DNS:www.conit.fi"
        - name: photoshoot.conikuvat.fi
          subject_alt_name: "DNS:photoshoot.conikuvat.fi"

        # bad name, but use this for all *.tracon.fi that run on neula
        - name: atlasso.tracon.fi
          subject_alt_name: "DNS:atlasso.tracon.fi,DNS:kompassi.tracon.fi,DNS:paikkaliput.tracon.fi"

- hosts: management-servers
  gather_facts: yes
  roles:
    - role: jenkins
      tags: [jenkins]

    - role: postgresql-docker
      tags: [postgresql-docker]
      postgresql_hostname: jenkins.tracon.fi
      postgresql_username: jenkinslave
      postgresql_password: "{{ jenkinslave_postgresql_password }}"
      postgresql_database: test_kompassi
      postgresql_ssl_certificate: /srv/letsencrypt/secrets/monokkeli.tracon.fi/chained.pem
      postgresql_ssl_certificate_key: /srv/letsencrypt/secrets/monokkeli.tracon.fi/domain.key

    - role: jenkinslave
      tags: [jenkinslave]

    - role: prometheus
      tags: [prometheus]

    # get SSL for future service
    - role: redirect
      tags: [redirect]
      redirect_hostname: kibana.tracon.fi
      redirect_allowed_hosts: kibana.tracon.fi
      redirect_target: https://tracon.fi
      redirect_ssl: false
      redirect_letsencrypt: true
      redirect_ssl_certificate: /srv/letsencrypt/secrets/monokkeli.tracon.fi/chained.pem
      redirect_ssl_certificate_key: /srv/letsencrypt/secrets/monokkeli.tracon.fi/domain.key

    - role: letsencrypt
      tags: [letsencrypt]
      letsencrypt_domains:
        - name: monokkeli.tracon.fi
          subject_alt_name: "DNS:jenkins.tracon.fi,DNS:kibana.tracon.fi,DNS:grafana.tracon.fi,DNS:prometheus.tracon.fi,DNS:alertmanager.tracon.fi,DNS:pgadmin.monokkeli.tracon.fi"


- hosts: hop-servers
  gather_facts: yes
  roles:
    - role: base
      tags: [base]
      nameservers:
        - 8.8.8.8
        - 8.8.4.4

    - role: node-exporter
      tags: [node-exporter]

    - role: prebackup
      tags: [prebackup]

    - role: nginx
      tags: [nginx]

    - role: redirect
      tags: [redirect]
      redirect_hostname: "{{ inventory_hostname }}"
      redirect_allowed_hosts: "{{ inventory_hostname }} www.{{ inventory_hostname }}"
      redirect_target: https://kompassi.eu
      redirect_default: true
      redirect_ssl_certificate: /srv/letsencrypt/secrets/putki.tracon.fi/chained.pem
      redirect_ssl_certificate_key: /srv/letsencrypt/secrets/putki.tracon.fi/domain.key

    - role: proxy
      tags: [proxy]
      proxy_hostname: vara.kompassi.eu

      # nuoli.kompassi.eu
      proxy_target: https://91.105.251.77

      proxy_ssl_certificate: /srv/letsencrypt/secrets/vara.kompassi.eu/chained.pem
      proxy_ssl_certificate_key: /srv/letsencrypt/secrets/vara.kompassi.eu/domain.key

    - role: letsencrypt
      tags: [letsencrypt]
      letsencrypt_domains:
        - name: putki.tracon.fi
          subject_alt_name: "DNS:putki.tracon.fi"
        - name: vara.kompassi.eu
          subject_alt_name: "DNS:vara.kompassi.eu"


- hosts: k3s
  gather_facts: yes
  roles:
    - role: k3s-base
      tags: [base, k3s, k3s-base]
    - role: k3s-storage
      tags: [k3s, k3s-storage]

- hosts: k3s-servers
  gather_facts: yes
  roles:
    - role: k3s-server
      tags: [k3s, k3s-server]

- hosts: k3s-nodes
  gather_facts: yes
  roles:
    - role: k3s-agent
      tags: [k3s, k3s-agent]
